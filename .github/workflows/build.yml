name: Build and Release Windows EXE

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

# 【关键设置】必须赋予写权限，否则无法创建 Release
permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"
        # 【核心功能】开启 pip 缓存
        # 只要 requirements.txt 没变，第二次运行就会秒装依赖！
        cache: 'pip'

    - name: Install Dependencies
      shell: cmd
      run: |
        python -m pip install --upgrade pip
        
        REM 安装依赖 (利用缓存)
        REM 请确保你的 requirements.txt 里第一行写了 --extra-index-url .../cpu
        pip install -r requirements.txt
        
        REM 验证版本
        python -c "import torch; print('Torch version:', torch.__version__)"

    - name: Run PyInstaller (Packaging)
      shell: cmd
      run: |
        REM 开始打包...
        pyinstaller --clean --onefile --name "DataGovernanceTool" ^
          --hidden-import="sklearn.utils._cython_blas" ^
          --hidden-import="sklearn.neighbors.typedefs" ^
          --hidden-import="sklearn.neighbors.quad_tree" ^
          --hidden-import="sklearn.tree._utils" ^
          --hidden-import="sentence_transformers" ^
          run_final_prod.py

    - name: Create Release (Fast Download)
      uses: softprops/action-gh-release@v1
      with:
        # 自动生成版本号：v1.0.流水线运行ID (例如 v1.0.42)
        tag_name: v1.0.${{ github.run_number }}
        name: Build Version ${{ github.run_number }}
        # 上传刚才打包好的 EXE
        files: dist/DataGovernanceTool.exe
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
